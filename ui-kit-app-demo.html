<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Master - SPA Demo</title>
    <link rel="stylesheet" href="css/ui-kit.css">
    
    <!-- ä¸šåŠ¡å±‚æ ·å¼ (App Specific Styles) -->
    <style>
        /* å¸ƒå±€å¾®è°ƒ */
        body { background-color: #f7f9fc; }
        
        /* é¡µé¢å®¹å™¨ */
        #app-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            /* é…åˆ UI Kit çš„ Sidebar padding */
            transition: padding-left 0.3s; 
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: #fff;
            border-radius: var(--ui-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;
        }
        .card-title { font-size: 18px; font-weight: bold; margin: 0; }

        /* æ•°æ®æ¦‚è§ˆå¡ç‰‡ */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; border-left: 4px solid var(--ui-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 12px; color: #999; margin: 0 0 5px 0; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #333; }

        /* ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; color: #666; }
        .data-table tr:hover { background-color: #f1f8ff; cursor: context-menu; }
        
        /* çŠ¶æ€å¾½æ ‡ */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-todo { background: #eef; color: #668; }
        .badge-doing { background: #fff8e1; color: #f57c00; }
        .badge-done { background: #e6fffa; color: #00bfa5; }

        /* æœç´¢æ  */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-input { padding: 8px; border: 1px solid var(--ui-border); border-radius: 4px; min-width: 250px; }

        /* æ¨¡æ‹Ÿè¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-control { width: 100%; padding: 8px; border: 1px solid var(--ui-border); border-radius: 4px; }
    </style>
</head>
<body>

    <!-- ä¸»å†…å®¹æŒ‚è½½ç‚¹ -->
    <div id="app-container">
        <!-- åŠ¨æ€å†…å®¹å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
    </div>

    <script src="js/ui-kit.js"></script>
    
    <!-- ä¸šåŠ¡é€»è¾‘è„šæœ¬ (App Logic) -->
    <script>
        /**
         * 1. æ¨¡æ‹Ÿåç«¯æ•°æ®æœåŠ¡ (Store)
         * ä½¿ç”¨ LocalStorage è¿›è¡Œæ•°æ®æŒä¹…åŒ–
         */
        const Store = {
            KEY: 'TASK_MASTER_DATA',
            
            getAll() {
                const data = localStorage.getItem(this.KEY);
                return data ? JSON.parse(data) : this._seedData();
            },

            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },

            // ç”Ÿæˆåˆå§‹å‡æ•°æ®
            _seedData() {
                const initial = [
                    { id: 1, title: 'è®¾è®¡æ–°ç‰ˆ UI åŸå‹', status: 'doing', priority: 'high', date: '2023-10-25' },
                    { id: 2, title: 'ä¿®å¤ç™»å½•é¡µ Bug', status: 'todo', priority: 'high', date: '2023-10-26' },
                    { id: 3, title: 'æ›´æ–° API æ–‡æ¡£', status: 'done', priority: 'low', date: '2023-10-24' },
                    { id: 4, title: 'å‘¨ä¼šæŠ¥å‘Šå‡†å¤‡', status: 'todo', priority: 'mid', date: '2023-10-27' },
                ];
                // ç”Ÿæˆæ›´å¤šæ•°æ®ä»¥æµ‹è¯•åˆ†é¡µ
                for(let i=5; i<=25; i++) {
                    initial.push({
                        id: i, 
                        title: `æµ‹è¯•ä»»åŠ¡é¡¹ #${i}`, 
                        status: ['todo','doing','done'][i%3], 
                        priority: ['low','mid','high'][i%3], 
                        date: '2023-11-01'
                    });
                }
                this.save(initial);
                return initial;
            },

            addTask(task) {
                const tasks = this.getAll();
                task.id = Date.now(); // ç®€å• ID ç”Ÿæˆ
                tasks.unshift(task);
                this.save(tasks);
                return task;
            },

            updateTask(id, updates) {
                let tasks = this.getAll();
                tasks = tasks.map(t => t.id == id ? { ...t, ...updates } : t);
                this.save(tasks);
            },

            deleteTask(id) {
                let tasks = this.getAll();
                tasks = tasks.filter(t => t.id != id);
                this.save(tasks);
            }
        };

        /**
         * 2. é¡µé¢è§†å›¾æ§åˆ¶å™¨ (Views)
         * åŒ…å«å…·ä½“çš„é¡µé¢æ¸²æŸ“é€»è¾‘
         */
        const Views = {
            // --- ä»ªè¡¨ç›˜è§†å›¾ ---
            dashboard: () => {
                const tasks = Store.getAll();
                const total = tasks.length;
                const done = tasks.filter(t => t.status === 'done').length;
                const pending = total - done;

                return `
                    <div class="stat-grid">
                        <div class="stat-card" style="border-color: #007bff">
                            <h3>æ€»ä»»åŠ¡</h3>
                            <div class="value">${total}</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745">
                            <h3>å·²å®Œæˆ</h3>
                            <div class="value">${done}</div>
                        </div>
                        <div class="stat-card" style="border-color: #ffc107">
                            <h3>è¿›è¡Œä¸­/å¾…åŠ</h3>
                            <div class="value">${pending}</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">æœ€è¿‘æ›´æ–°</h2>
                            <button class="ui-btn ui-btn--default" onclick="Router.go('tasks')">æŸ¥çœ‹å…¨éƒ¨ &rarr;</button>
                        </div>
                        <p style="color:#666; font-size:14px;">è¿™é‡Œå¯ä»¥æ”¾ç½®å›¾è¡¨ç»„ä»¶ï¼Œæˆ–è€…ç®€ç•¥çš„ä»»åŠ¡åˆ—è¡¨ã€‚</p>
                        <div style="height: 200px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 2px dashed #eee;">
                            å›¾è¡¨åŒºåŸŸå ä½ç¬¦
                        </div>
                    </div>
                `;
            },

            // --- ä»»åŠ¡åˆ—è¡¨è§†å›¾ (æ ¸å¿ƒåŠŸèƒ½) ---
            tasks: (container) => {
                let currentPage = 1;
                const pageSize = 8;
                let currentFilter = '';

                // æ¸²æŸ“ä¸»ç»“æ„
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ä»»åŠ¡ç®¡ç†</h2>
                            <button class="ui-btn ui-btn--primary" id="btn-add-task">+ æ–°å»ºä»»åŠ¡</button>
                        </div>
                        
                        <div class="toolbar">
                            <input type="text" class="search-input" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜..." id="task-search">
                            <div id="filter-select-container" style="width: 150px;"></div>
                        </div>

                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æ ‡é¢˜</th>
                                        <th>ä¼˜å…ˆçº§</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æˆªæ­¢æ—¥æœŸ</th>
                                        <th style="text-align:right">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="task-table-body"></tbody>
                            </table>
                        </div>

                        <div id="pagination-container" style="margin-top: 20px; display: flex; justify-content: flex-end;"></div>
                    </div>
                `;

                // ç»‘å®šæ–°å»ºæŒ‰é’®
                document.getElementById('btn-add-task').onclick = () => Actions.openTaskModal();

                // æ¸²æŸ“ç­›é€‰ä¸‹æ‹‰æ¡†
                UIKit.renderSelect(document.getElementById('filter-select-container'), {
                    placeholder: 'æ‰€æœ‰çŠ¶æ€',
                    data: [
                        { label: 'æ‰€æœ‰çŠ¶æ€', value: '' },
                        { label: 'å¾…åŠ (Todo)', value: 'todo' },
                        { label: 'è¿›è¡Œä¸­ (Doing)', value: 'doing' },
                        { label: 'å·²å®Œæˆ (Done)', value: 'done' }
                    ],
                    onChange: (val) => {
                        currentFilter = val;
                        currentPage = 1;
                        renderTable();
                    }
                });

                // ç»‘å®šæœç´¢
                document.getElementById('task-search').oninput = (e) => {
                    currentFilter = e.target.value.toLowerCase(); // ç®€å•å¤ç”¨ filter å˜é‡é€»è¾‘
                    currentPage = 1;
                    renderTable();
                };

                // å†…éƒ¨æ¸²æŸ“è¡¨æ ¼å‡½æ•°
                const renderTable = () => {
                    const allTasks = Store.getAll();
                    
                    // è¿‡æ»¤é€»è¾‘ (æ··åˆäº†æœç´¢å’ŒçŠ¶æ€ç­›é€‰ï¼Œæ¼”ç¤ºç”¨)
                    const filtered = allTasks.filter(t => {
                        const matchText = t.title.toLowerCase().includes(document.getElementById('task-search').value.toLowerCase());
                        const statusVal = document.querySelector('#filter-select-container input')?.value;
                        const matchStatus = statusVal ? t.status === statusVal : true;
                        return matchText && matchStatus;
                    });

                    // åˆ†é¡µé€»è¾‘
                    const start = (currentPage - 1) * pageSize;
                    const pageData = filtered.slice(start, start + pageSize);
                    
                    const tbody = document.getElementById('task-table-body');
                    tbody.innerHTML = '';

                    if (pageData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999">æš‚æ— æ•°æ®</td></tr>';
                    }

                    pageData.forEach(task => {
                        const tr = document.createElement('tr');
                        
                        // çŠ¶æ€å¾½æ ‡æ˜ å°„
                        const badgeClass = { 'todo': 'badge-todo', 'doing': 'badge-doing', 'done': 'badge-done' };
                        const statusText = { 'todo': 'å¾…åŠ', 'doing': 'è¿›è¡Œä¸­', 'done': 'å·²å®Œæˆ' };

                        tr.innerHTML = `
                            <td>#${task.id}</td>
                            <td><span style="font-weight:500">${task.title}</span></td>
                            <td>${task.priority === 'high' ? '<span style="color:var(--ui-danger)">High</span>' : task.priority === 'mid' ? 'Medium' : 'Low'}</td>
                            <td><span class="badge ${badgeClass[task.status]}">${statusText[task.status]}</span></td>
                            <td>${task.date}</td>
                            <td style="text-align:right">
                                <button class="ui-btn ui-btn--default" style="padding:4px 8px; font-size:12px;" onclick="Actions.editTask(${task.id})">ç¼–è¾‘</button>
                            </td>
                        `;

                        // å³é”®èœå•é›†æˆ
                        tr.addEventListener('contextmenu', (e) => {
                            UIKit.contextMenu(e, [
                                { label: 'âœï¸ ç¼–è¾‘ä»»åŠ¡', action: () => Actions.editTask(task.id) },
                                { label: 'ğŸ“‹ å¤åˆ¶æ ‡é¢˜', action: () => UIKit.copyToClipboard(task.title) },
                                { label: 'ğŸ—‘ï¸ åˆ é™¤', action: () => Actions.deleteTask(task.id, renderTable) }
                            ]);
                        });

                        tbody.appendChild(tr);
                    });

                    // æ¸²æŸ“åˆ†é¡µ
                    UIKit.renderPagination(document.getElementById('pagination-container'), {
                        current: currentPage,
                        total: filtered.length,
                        pageSize: pageSize
                    }, (page) => {
                        currentPage = page;
                        renderTable();
                    });
                };

                renderTable(); // åˆå§‹æ‰§è¡Œ
            },

            // --- è®¾ç½®è§†å›¾ ---
            settings: (container) => {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">ä¸ªäººè®¾ç½®</h2></div>
                        
                        <div style="display:flex; gap:30px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:300px;">
                                <div class="form-group">
                                    <label class="form-label">å¤´åƒä¸Šä¼ </label>
                                    <div class="ui-upload" id="avatar-upload">
                                        <div class="ui-upload__icon">ğŸ“·</div>
                                        <div class="ui-upload__text">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                                        <input type="file" accept="image/*">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">æ˜¾ç¤ºåç§°</label>
                                    <input type="text" class="form-control" value="Admin User">
                                </div>
                            </div>

                            <div style="flex:1; min-width:300px;">
                                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                                    <span>å¯ç”¨é‚®ä»¶é€šçŸ¥</span>
                                    <label class="ui-switch"><input type="checkbox" checked><span class="ui-switch__slider"></span></label>
                                </div>
                                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                                    <span>æ·±è‰²æ¨¡å¼ (Beta)</span>
                                    <label class="ui-switch"><input type="checkbox"><span class="ui-switch__slider"></span></label>
                                </div>
                                <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
                                <button class="ui-btn ui-btn--primary" onclick="UIKit.showLoading('ä¿å­˜ä¸­...'); setTimeout(() => { UIKit.hideLoading(); UIKit.toast('è®¾ç½®å·²ä¿å­˜','success') }, 1000)">ä¿å­˜è®¾ç½®</button>
                            </div>
                        </div>
                    </div>
                `;

                // ç»‘å®šä¸Šä¼ äº‹ä»¶
                UIKit.initUploads('#avatar-upload', (files) => {
                    UIKit.toast('å¤´åƒä¸Šä¼ æ¨¡æ‹ŸæˆåŠŸ', 'success');
                    // å®é™…åœºæ™¯è¿™é‡Œä¼šè°ƒç”¨ UIKit.previewImage(URL.createObjectURL(files[0]))
                });
            }
        };

        /**
         * 3. ä¸šåŠ¡åŠ¨ä½œå¤„ç† (Actions)
         * å¤„ç†å¼¹çª—ã€æäº¤è¡¨å•ç­‰äº¤äº’é€»è¾‘
         */
        const Actions = {
            // æ‰“å¼€ä»»åŠ¡æ¨¡æ€æ¡† (æ–°å»ºæˆ–ç¼–è¾‘)
            openTaskModal: (task = null) => {
                const isEdit = !!task;
                
                // åŠ¨æ€æ„å»ºè¡¨å• HTML
                const formHtml = `
                    <div id="task-form">
                        <div class="form-group">
                            <label class="form-label">ä»»åŠ¡æ ‡é¢˜</label>
                            <input type="text" name="title" class="form-control" value="${task ? task.title : ''}" placeholder="è¾“å…¥è¦åšä»€ä¹ˆ...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <div id="modal-priority-select"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                            <input type="date" name="date" class="form-control" value="${task ? task.date : new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                `;

                // æ‰“å¼€ Modal
                UIKit.modal({
                    title: isEdit ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ–°å»ºä»»åŠ¡',
                    content: formHtml,
                    width: '500px'
                }).then((result) => {
                    if (result === true) { // ç‚¹å‡»äº†ç¡®å®š
                        handleSubmit();
                    }
                });

                // éœ€è¦åœ¨ Modal æ¸²æŸ“ååˆå§‹åŒ– Select ç»„ä»¶ (å› ä¸º Select éœ€è¦ DOM èŠ‚ç‚¹)
                // è¿™é‡Œä½¿ç”¨ setTimeout 0 è®© event loop è·‘å®Œ DOM æ’å…¥
                setTimeout(() => {
                    const selectContainer = document.getElementById('modal-priority-select');
                    UIKit.renderSelect(selectContainer, {
                        name: 'priority',
                        data: [
                            { label: 'Low', value: 'low' },
                            { label: 'Medium', value: 'mid' },
                            { label: 'High', value: 'high' }
                        ],
                        defaultValue: task ? task.priority : 'mid'
                    });
                }, 0);

                // å¤„ç†è¡¨å•æäº¤é€»è¾‘
                const handleSubmit = () => {
                    const title = document.querySelector('#task-form input[name="title"]').value;
                    const date = document.querySelector('#task-form input[name="date"]').value;
                    const priority = document.querySelector('#task-form input[name="priority"]').value;

                    if (!title) {
                        UIKit.toast('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                        return;
                    }

                    if (isEdit) {
                        Store.updateTask(task.id, { title, date, priority });
                        UIKit.toast('ä»»åŠ¡å·²æ›´æ–°', 'success');
                    } else {
                        Store.addTask({ title, date, priority, status: 'todo' });
                        UIKit.toast('ä»»åŠ¡å·²åˆ›å»º', 'success');
                    }

                    // åˆ·æ–°å½“å‰é¡µé¢
                    Router.refresh();
                };
            },

            editTask: (id) => {
                const task = Store.getAll().find(t => t.id === id);
                if (task) Actions.openTaskModal(task);
            },

            deleteTask: (id, callback) => {
                UIKit.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚', 'åˆ é™¤è­¦å‘Š')
                    .then(yes => {
                        if (yes) {
                            Store.deleteTask(id);
                            UIKit.toast('å·²åˆ é™¤', 'success');
                            if (callback) callback();
                            else Router.refresh();
                        }
                    });
            }
        };

        /**
         * 4. è·¯ç”±ç®¡ç†å™¨ (Router)
         */
        const Router = {
            routes: {
                'dashboard': Views.dashboard,
                'tasks': Views.tasks,
                'settings': Views.settings
            },
            
            init() {
                window.addEventListener('hashchange', () => this.load());
                this.load();
                this.renderNav();
            },

            go(hash) {
                window.location.hash = hash;
            },

            load() {
                const hash = window.location.hash.replace('#', '') || 'dashboard';
                const container = document.getElementById('app-container');
                const viewFn = this.routes[hash];

                if (viewFn) {
                    // æ¸…ç©ºå®¹å™¨
                    container.innerHTML = '';
                    
                    // æ¸²æŸ“è§†å›¾ (æ”¯æŒè¿”å› HTML å­—ç¬¦ä¸²æˆ–æ“ä½œ DOM)
                    const content = viewFn(container);
                    if (typeof content === 'string') {
                        container.innerHTML = content;
                    }

                    // æ›´æ–°å¯¼èˆªé«˜äº®
                    this.renderNav(hash);
                } else {
                    container.innerHTML = '<h1>404 Not Found</h1>';
                }
            },
            
            refresh() {
                this.load();
            },

            renderNav(activeId = '') {
                // å¦‚æœæ˜¯åˆå§‹åŒ–ï¼ŒactiveId å¯èƒ½ä¸ºç©ºï¼Œä» URL è·å–
                if (!activeId) activeId = window.location.hash.replace('#', '') || 'dashboard';

                UIKit.renderResponsiveNav([
                    { label: 'ä»ªè¡¨ç›˜', icon: 'ğŸ“Š', id: 'dashboard', onClick: () => this.go('dashboard') },
                    { label: 'ä»»åŠ¡åˆ—è¡¨', icon: 'ğŸ“', id: 'tasks', onClick: () => this.go('tasks') },
                    { label: 'è®¾ç½®', icon: 'âš™ï¸', id: 'settings', onClick: () => this.go('settings') },
                    { label: 'å¸®åŠ©', icon: 'â“', id: 'help', onClick: () => UIKit.alert('è¿™æ˜¯åŸºäº UI Kit æ„å»ºçš„ SPA æ¼”ç¤ºã€‚') }
                ], activeId);
            }
        };

        // --- å¯åŠ¨åº”ç”¨ ---
        document.addEventListener('DOMContentLoaded', () => {
            // æ¨¡æ‹Ÿ API å»¶è¿ŸåŠ è½½
            UIKit.showLoading('ç³»ç»Ÿåˆå§‹åŒ–...');
            setTimeout(() => {
                UIKit.hideLoading();
                Router.init();
            }, 800);
        });

    </script>
</body>
</html>