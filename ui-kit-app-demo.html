<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Master Pro - Complete Refactor</title>

    <!-- 1. 框架与样式库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/ui-kit.css">
    
    <!-- 2. 图标库与逻辑库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        /* 胶水样式：协调 Bootstrap 和 UI Kit */
        body { background-color: #f7f9fc; font-family: var(--ui-font-family); color: var(--ui-text); }
        .app-container { padding: 24px; max-width: 1200px; margin: 0 auto; transition: padding-left 0.3s ease; }
        
        /* 增强型卡片 (匹配原版视觉) */
        .custom-card {
            border: none; border-radius: var(--ui-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); background: #fff;
            height: 100%; transition: transform 0.2s;
        }
        /* 图表占位符样式 */
        .chart-placeholder {
            height: 200px; background: #f9f9f9; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 4px; border: 2px dashed #eee;
            color: #999; font-size: 14px; flex-direction: column; gap: 10px;
        }
        
        /* 状态徽章 */
        .badge-pill { padding: 0.4em 0.8em; border-radius: 50rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px; font-size: 12px; }
        
        /* 辅助类 */
        .icon-btn { padding: 4px 8px; display: inline-flex; align-items: center; justify-content: center; }
        .form-label { font-weight: 500; font-size: 14px; margin-bottom: 0.5rem; display: block; }
    </style>
</head>

<body x-data="app()" x-init="initApp()">

    <div id="main-content" class="app-container">
        
        <!-- 顶部导航 -->
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="m-0 fw-bold d-flex align-items-center gap-2">
                    <i :data-lucide="getPageIcon()"></i> <span x-text="getPageTitle()"></span>
                </h2>
                <div id="breadcrumb" class="mt-2 text-muted small"></div>
            </div>
            <!-- 用户 Popover 触发器 -->
            <button class="ui-btn ui-btn--default d-flex align-items-center gap-2" @click="showUser($el)">
                <i data-lucide="user" width="16"></i> <span x-text="user.name"></span>
            </button>
        </header>

        <!-- ==================== 视图: 仪表盘 ==================== -->
        <div x-show="route === 'dashboard'" x-transition.opacity>
            <!-- 统计卡片区域 -->
            <div class="row g-4 mb-4">
                <template x-for="stat in getStats()" :key="stat.label">
                    <div class="col-md-4">
                        <div class="custom-card p-4 border-start border-4" :class="stat.borderClass">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="text-muted small fw-bold text-uppercase" x-text="stat.label"></div>
                                    <div class="fs-2 fw-bold mt-1" :class="stat.textClass" x-text="stat.value"></div>
                                </div>
                                <div :class="stat.bgClass" class="p-2 rounded d-flex align-items-center h-100">
                                    <i :data-lucide="stat.icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- (补回) 最近更新与图表区域 -->
            <div class="custom-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <h5 class="m-0 fw-bold">最近更新</h5>
                    <button class="ui-btn ui-btn--default d-flex align-items-center gap-1" @click="setRoute('tasks')">
                        查看全部 <i data-lucide="arrow-right" width="14"></i>
                    </button>
                </div>
                <p class="text-muted small">这里展示了最近一周的任务完成趋势图表。</p>
                <!-- 图表占位符 -->
                <div class="chart-placeholder">
                    <i data-lucide="bar-chart-2" width="40" height="40" class="text-muted opacity-50"></i>
                    <span>图表区域占位符 (Chart Area)</span>
                </div>
            </div>
        </div>

        <!-- ==================== 视图: 任务列表 ==================== -->
        <div x-show="route === 'tasks'" x-transition.opacity>
            <div class="custom-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                    <h2 class="fs-5 fw-bold m-0">任务管理</h2>
                    <button class="ui-btn ui-btn--primary d-flex align-items-center gap-1" @click="openModal()">
                        <i data-lucide="plus" width="16"></i> 新建任务
                    </button>
                </div>

                <!-- 工具栏 -->
                <div class="d-flex flex-wrap gap-3 mb-4">
                    <div class="position-relative" style="min-width: 250px;">
                        <i data-lucide="search" class="position-absolute top-50 start-0 translate-middle-y ms-2 text-muted" width="16"></i>
                        <input type="text" class="ui-dialog__input ps-5 w-100" placeholder="搜索任务标题..." x-model="search">
                    </div>
                    <div x-ref="filterSelect" style="min-width: 150px;"></div>
                </div>

                <!-- 表格 -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>ID</th><th>标题</th><th>优先级</th><th>状态</th><th>截止日期</th><th class="text-end">操作</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="task in pagedTasks" :key="task.id">
                                <tr @contextmenu.prevent="showContext($event, task)">
                                    <td class="text-muted" x-text="'#'+task.id"></td>
                                    <td>
                                        <div class="fw-bold" x-text="task.title"></div>
                                    </td>
                                    <td>
                                        <span class="badge-pill" :class="priorityClass(task.priority)">
                                            <i :data-lucide="priorityIcon(task.priority)" width="12"></i>
                                            <span x-text="formatEnum(task.priority)"></span>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge-pill" :class="statusClass(task.status)">
                                            <i :data-lucide="statusIcon(task.status)" width="12"></i>
                                            <span x-text="statusLabel(task.status)"></span>
                                        </span>
                                    </td>
                                    <td x-text="task.date"></td>
                                    <td class="text-end">
                                        <button class="ui-btn ui-btn--default icon-btn" style="font-size: 12px;" @click="openModal(task)">编辑</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="pagedTasks.length===0"><td colspan="6" class="text-center py-5 text-muted">暂无数据</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="d-flex justify-content-end mt-3" x-ref="pagination"></div>
            </div>
        </div>

        <!-- ==================== 视图: 设置 ==================== -->
        <div x-show="route === 'settings'" x-transition.opacity>
            <div class="custom-card">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center gap-2 mb-4 pb-2 border-bottom">
                        <h2 class="fs-5 fw-bold m-0">个人设置</h2>
                    </div>

                    <div class="row g-5">
                        <!-- 左侧：表单 -->
                        <div class="col-md-7">
                            <!-- (补回) 头像上传 -->
                            <div class="form-group mb-4">
                                <label class="form-label">头像上传</label>
                                <div class="ui-upload p-3" @click="$refs.fileInput.click()">
                                    <div class="ui-upload__icon mb-2"><i data-lucide="camera" width="24"></i></div>
                                    <div class="ui-upload__text small">点击更换头像</div>
                                    <input type="file" x-ref="fileInput" hidden @change="handleFileUpload">
                                </div>
                            </div>

                            <!-- (补回) 显示名称 -->
                            <div class="form-group mb-4">
                                <label class="form-label">显示名称</label>
                                <input type="text" class="ui-dialog__input w-100" x-model="user.name">
                            </div>
                        </div>

                        <!-- 右侧：开关 -->
                        <div class="col-md-5">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <div class="fw-bold">启用邮件通知</div>
                                    <small class="text-muted">接收每日任务摘要</small>
                                </div>
                                <label class="ui-switch">
                                    <input type="checkbox" x-model="user.notify">
                                    <span class="ui-switch__slider"></span>
                                </label>
                            </div>

                            <hr class="text-muted my-4">
                            
                            <button class="ui-btn ui-btn--primary w-100 d-flex justify-content-center gap-2" @click="saveSettings">
                                <i data-lucide="save" width="16"></i> 保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- UI Kit 逻辑 -->
    <script src="js/ui-kit.js"></script>

    <!-- 业务逻辑 -->
    <script>
        function app() {
            return {
                // --- 状态数据 ---
                route: 'dashboard',
                tasks: [],
                search: '',
                filter: '',
                page: 1,
                pageSize: 8,
                user: { 
                    name: 'Admin User', 
                    notify: true, 
                    darkMode: false 
                },

                // --- 计算属性 ---
                get filteredTasks() {
                    return this.tasks.filter(t => {
                        const matchSearch = t.title.toLowerCase().includes(this.search.toLowerCase());
                        const matchFilter = !this.filter || t.status === this.filter;
                        return matchSearch && matchFilter;
                    });
                },
                get pagedTasks() {
                    const start = (this.page - 1) * this.pageSize;
                    return this.filteredTasks.slice(start, start + this.pageSize);
                },

                // --- 初始化 ---
                initApp() {
                    // 1. 加载数据 (含默认种子数据)
                    this.loadData();
                    
                    // 2. 渲染导航栏 (UI Kit)
                    this.renderNav();
                    
                    // 3. 初始化 Select 组件 (UI Kit)
                    this.$nextTick(() => {
                        this.initSelect();
                    });

                    // 4. 监听器: 路由/数据变化时刷新 UI
                    this.$watch('route', () => { this.updateBreadcrumb(); this.refreshIcons(); });
                    this.$watch('filteredTasks', () => { this.page = 1; this.renderPager(); this.refreshIcons(); });
                    this.$watch('page', () => { this.renderPager(); this.refreshIcons(); });
                    
                    this.updateBreadcrumb();
                    this.refreshIcons(); // 首次渲染图标
                },

                // --- 核心方法 ---
                refreshIcons() { this.$nextTick(() => lucide.createIcons()); },

                loadData() {
                    const storedTasks = localStorage.getItem('TM_TASKS');
                    const storedUser = localStorage.getItem('TM_USER');
                    
                    if (storedUser) this.user = JSON.parse(storedUser);
                    
                    if (storedTasks) {
                        this.tasks = JSON.parse(storedTasks);
                    } else {
                        // 种子数据 (还原原版逻辑)
                        this.tasks = [
                            { id: 1, title: '设计新版 UI 原型', status: 'doing', priority: 'high', date: '2023-10-25' },
                            { id: 2, title: '修复登录页 Bug', status: 'todo', priority: 'high', date: '2023-10-26' },
                            { id: 3, title: '更新 API 文档', status: 'done', priority: 'low', date: '2023-10-24' },
                            { id: 4, title: '周会报告准备', status: 'todo', priority: 'mid', date: '2023-10-27' },
                        ];
                        // 补充数据以展示分页
                        for(let i=5; i<=25; i++) {
                            this.tasks.push({
                                id: i, 
                                title: `测试任务项 #${i}`, 
                                status: ['todo','doing','done'][i%3], 
                                priority: ['low','mid','high'][i%3], 
                                date: '2023-11-01'
                            });
                        }
                        this.saveTasks();
                    }
                },

                saveTasks() { localStorage.setItem('TM_TASKS', JSON.stringify(this.tasks)); },
                saveUser() { localStorage.setItem('TM_USER', JSON.stringify(this.user)); },

                // --- UI 渲染方法 ---
                renderNav() {
                    UIKit.renderResponsiveNav([
                        { label: '仪表盘', icon: '<i data-lucide="layout-dashboard" width="18"></i>', id: 'dashboard', onClick: () => this.setRoute('dashboard') },
                        { label: '任务列表', icon: '<i data-lucide="list-todo" width="18"></i>', id: 'tasks', onClick: () => this.setRoute('tasks') },
                        { label: '设置', icon: '<i data-lucide="settings" width="18"></i>', id: 'settings', onClick: () => this.setRoute('settings') }
                    ], this.route);
                    this.refreshIcons(); // 必须在 DOM 更新后调用
                },
                
                setRoute(id) { this.route = id; this.renderNav(); },

                initSelect() {
                    if (this.$refs.filterSelect) {
                        UIKit.renderSelect(this.$refs.filterSelect, {
                            placeholder: '所有状态',
                            data: [
                                { label: '所有状态', value: '' }, 
                                { label: '待办 (Todo)', value: 'todo' }, 
                                { label: '进行中 (Doing)', value: 'doing' }, 
                                { label: '已完成 (Done)', value: 'done' }
                            ],
                            onChange: (val) => this.filter = val
                        });
                    }
                },

                renderPager() {
                    if(this.$refs.pagination && this.route === 'tasks') {
                        UIKit.renderPagination(this.$refs.pagination, {
                            current: this.page, total: this.filteredTasks.length, pageSize: this.pageSize
                        }, (p) => this.page = p);
                    }
                },

                updateBreadcrumb() {
                    const el = document.getElementById('breadcrumb');
                    if(el) UIKit.renderBreadcrumb(el, [{ label: '首页' }, { label: this.getPageTitle() }]);
                },

                // --- 业务操作 ---
                deleteTask(id) {
                    UIKit.confirm('确定要删除这个任务吗？此操作无法撤销。', '删除警告').then(yes => {
                        if(yes) { this.tasks = this.tasks.filter(t => t.id !== id); this.saveTasks(); UIKit.toast('已删除', 'success'); }
                    });
                },

                openModal(task = null) {
                    const isEdit = !!task;
                    const data = task || { title: '', priority: 'mid', date: new Date().toISOString().split('T')[0] };
                    
                    // 动态构建 HTML (保留原版表单结构)
                    const content = `
                        <div class="mb-3"><label class="form-label">任务标题</label><input id="m-title" class="ui-dialog__input" value="${data.title}" placeholder="输入要做什么..."></div>
                        <div class="mb-3"><label class="form-label">优先级</label><div id="m-prio"></div></div>
                        <div class="mb-3"><label class="form-label">截止日期</label><input id="m-date" type="date" class="ui-dialog__input" value="${data.date}"></div>
                    `;

                    UIKit.modal({
                        title: isEdit ? '编辑任务' : '新建任务', width: '500px', content: content
                    }).then(ok => {
                        if(ok) {
                            const title = document.getElementById('m-title').value;
                            const date = document.getElementById('m-date').value;
                            // 从 UI Kit Select 的隐藏 input 获取值
                            const prioInput = document.querySelector('#m-prio input');
                            const prio = prioInput ? prioInput.value : 'mid';

                            if(!title) return UIKit.toast('标题不能为空', 'error');

                            if(isEdit) {
                                const idx = this.tasks.findIndex(t => t.id === task.id);
                                this.tasks[idx] = { ...this.tasks[idx], title, date, priority: prio };
                                UIKit.toast('任务已更新', 'success');
                            } else {
                                this.tasks.unshift({ id: Date.now(), title, date, priority: prio, status: 'todo' });
                                UIKit.toast('任务已创建', 'success');
                            }
                            this.saveTasks(); 
                        }
                    });

                    // 异步初始化 Modal 内的 Select
                    setTimeout(() => {
                        const el = document.getElementById('m-prio');
                        if (el) {
                            UIKit.renderSelect(el, {
                                name: 'priority', data: [{label:'Low',value:'low'},{label:'Medium',value:'mid'},{label:'High',value:'high'}],
                                defaultValue: data.priority
                            });
                        }
                    }, 50);
                },

                showContext(e, task) {
                    UIKit.contextMenu(e, [
                        { label: '<span class="icon-btn ps-0"><i data-lucide="edit" width="14"></i> 编辑任务</span>', action: () => this.openModal(task) },
                        { label: '<span class="icon-btn ps-0"><i data-lucide="copy" width="14"></i> 复制标题</span>', action: () => UIKit.copyToClipboard(task.title) },
                        { label: '<span class="icon-btn ps-0 text-danger"><i data-lucide="trash" width="14"></i> 删除</span>', action: () => this.deleteTask(task.id) }
                    ]);
                    this.refreshIcons(); // 菜单插入后需渲染图标
                },

                showUser(el) {
                    UIKit.popover(el, `
                        <div class="p-2 text-center">
                            <div class="fw-bold mb-1">${this.user.name}</div>
                            <div class="text-muted small mb-2">管理员</div>
                            <button class="ui-btn ui-btn--primary w-100" onclick="location.reload()">注销</button>
                        </div>
                    `);
                },
                
                handleFileUpload(e) {
                    if (e.target.files.length > 0) {
                        UIKit.toast(`头像 "${e.target.files[0].name}" 上传模拟成功`, 'success');
                    }
                },

                saveSettings() {
                    UIKit.showLoading('保存中...');
                    setTimeout(() => { 
                        this.saveUser();
                        UIKit.hideLoading(); 
                        UIKit.toast('设置已保存', 'success'); 
                    }, 1000);
                },

                // --- 辅助函数 ---
                getPageTitle() { return {'dashboard':'仪表盘','tasks':'任务管理','settings':'个人设置'}[this.route]; },
                getPageIcon() { return {'dashboard':'layout-dashboard','tasks':'list-todo','settings':'settings'}[this.route]; },
                
                getStats() {
                    const total = this.tasks.length;
                    const done = this.tasks.filter(t=>t.status==='done').length;
                    const pending = total - done;
                    return [
                        { label: '总任务', value: total, borderClass: 'border-primary', textClass: 'text-dark', bgClass: 'bg-primary bg-opacity-10 text-primary', icon: 'layers' },
                        { label: '已完成', value: done, borderClass: 'border-success', textClass: 'text-dark', bgClass: 'bg-success bg-opacity-10 text-success', icon: 'check-circle' },
                        { label: '进行中/待办', value: pending, borderClass: 'border-warning', textClass: 'text-dark', bgClass: 'bg-warning bg-opacity-10 text-warning', icon: 'clock' }
                    ];
                },
                
                formatEnum(val) { return val.charAt(0).toUpperCase() + val.slice(1); },
                
                priorityClass(p) { return {'high':'bg-danger bg-opacity-10 text-danger','mid':'bg-warning bg-opacity-10 text-dark','low':'bg-info bg-opacity-10 text-dark'}[p]; },
                priorityIcon(p) { return {'high':'alert-circle','mid':'minus','low':'arrow-down'}[p]; },
                
                statusClass(s) { return {'done':'bg-success bg-opacity-10 text-success','doing':'bg-warning bg-opacity-10 text-warning','todo':'bg-secondary bg-opacity-10 text-dark'}[s]; },
                statusIcon(s) { return {'done':'check','doing':'loader','todo':'circle'}[s]; },
                statusLabel(s) { return {'done':'已完成','doing':'进行中','todo':'待办'}[s]; }
            }
        }
    </script>
</body>
</html>