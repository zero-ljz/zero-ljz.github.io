<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Master Pro - Bootstrap Refactor</title>

    <!-- 1. Bootstrap 5 CSS (核心样式来源) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- 2. 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Alpine.js (逻辑库) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- 4. Bootstrap JS (用于模态框等交互) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light" x-data="app()" x-init="initApp()">

    <!-- 布局容器 -->
    <div class="container py-4" style="max-width: 1140px;">

        <!-- ==================== 顶部标题与导航区 (优化布局) ==================== -->
        <header class="card shadow-sm border-0 mb-4">
            <div class="card-body d-flex justify-content-between align-items-center py-3">
                
                <!-- 左侧：标题与面包屑 -->
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-3 d-flex align-items-center justify-content-center">
                        <i :data-lucide="getPageIcon()" width="28" height="28"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold mb-0 text-dark" x-text="getPageTitle()"></h4>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 small">
                                <li class="breadcrumb-item"><a href="#dashboard" class="text-decoration-none text-muted">首页</a></li>
                                <li class="breadcrumb-item active" aria-current="page" x-text="getPageTitle()"></li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <!-- 右侧：导航菜单与用户信息 -->
                <div class="d-flex align-items-center gap-2">
                    <!-- 导航按钮组 -->
                    <div class="btn-group me-3" role="group">
                        <a href="#dashboard" class="btn btn-outline-secondary d-flex align-items-center gap-2" :class="{ 'active': route === 'dashboard' }">
                            <i data-lucide="layout-dashboard" width="16"></i> <span class="d-none d-md-inline">概览</span>
                        </a>
                        <a href="#tasks" class="btn btn-outline-secondary d-flex align-items-center gap-2" :class="{ 'active': route === 'tasks' }">
                            <i data-lucide="list-todo" width="16"></i> <span class="d-none d-md-inline">任务</span>
                        </a>
                        <a href="#settings" class="btn btn-outline-secondary d-flex align-items-center gap-2" :class="{ 'active': route === 'settings' }">
                            <i data-lucide="settings" width="16"></i> <span class="d-none d-md-inline">设置</span>
                        </a>
                    </div>

                    <!-- 用户下拉 (模拟) -->
                    <div class="dropdown">
                        <button class="btn btn-light border d-flex align-items-center gap-2 rounded-pill px-3" type="button" data-bs-toggle="dropdown">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 12px;">A</div>
                            <span class="small fw-medium">Admin</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0">
                            <li><h6 class="dropdown-header">已登录</h6></li>
                            <li><a class="dropdown-item" href="#settings">个人设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="javascript:location.reload()">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- ==================== 内容区域 ==================== -->
        <main>

            <!-- 1. 仪表盘视图 -->
            <div x-show="route === 'dashboard'" x-transition.opacity.duration.300ms>
                <!-- 统计卡片 -->
                <div class="row g-4 mb-4">
                    <template x-for="stat in getStats()" :key="stat.label">
                        <div class="col-md-4">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-uppercase text-muted small fw-bold mb-2" x-text="stat.label"></h6>
                                        <h2 class="mb-0 fw-bold" x-text="stat.value"></h2>
                                    </div>
                                    <div class="rounded-circle p-3 d-flex align-items-center justify-content-center" :class="stat.bgClass">
                                        <i :data-lucide="stat.icon" width="24" height="24"></i>
                                    </div>
                                </div>
                                <!-- 底部装饰条 -->
                                <div class="card-footer border-0 py-1" :class="stat.borderClass" style="border-bottom-left-radius: inherit; border-bottom-right-radius: inherit;"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- 图表占位区 -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 fw-bold">本周趋势</h5>
                        <a href="#tasks" class="btn btn-sm btn-light text-primary fw-medium">查看所有任务</a>
                    </div>
                    <div class="card-body text-center py-5 bg-light bg-opacity-50 m-3 rounded border border-dashed">
                        <i data-lucide="bar-chart-2" width="48" height="48" class="text-muted opacity-25 mb-3"></i>
                        <p class="text-muted mb-0">图表组件区域 (Chart Area)</p>
                    </div>
                </div>
            </div>

            <!-- 2. 任务列表视图 -->
            <div x-show="route === 'tasks'" x-transition.opacity.duration.300ms>
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <h5 class="mb-0 fw-bold">任务列表</h5>
                        <div class="d-flex gap-2">
                            <!-- 搜索框 -->
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <span class="input-group-text bg-white border-end-0"><i data-lucide="search" width="14"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" placeholder="搜索任务..." x-model="search">
                            </div>
                            <!-- 状态筛选 -->
                            <select class="form-select form-select-sm w-auto" x-model="filter">
                                <option value="">所有状态</option>
                                <option value="todo">待办</option>
                                <option value="doing">进行中</option>
                                <option value="done">已完成</option>
                            </select>
                            <!-- 新建按钮 -->
                            <button class="btn btn-sm btn-primary d-flex align-items-center gap-1" @click="openModal()">
                                <i data-lucide="plus" width="14"></i> 新建
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">任务名称</th>
                                    <th>优先级</th>
                                    <th>状态</th>
                                    <th>截止日期</th>
                                    <th class="text-end pe-4">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="task in pagedTasks" :key="task.id">
                                    <tr>
                                        <td class="ps-4">
                                            <div class="fw-medium text-dark" x-text="task.title"></div>
                                            <div class="small text-muted" x-text="'ID: #' + task.id"></div>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill" :class="getPriorityBadge(task.priority)">
                                                <span x-text="formatEnum(task.priority)"></span>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill border" :class="getStatusBadge(task.status)">
                                                <i :data-lucide="getStatusIcon(task.status)" width="10" class="me-1"></i>
                                                <span x-text="statusLabel(task.status)"></span>
                                            </span>
                                        </td>
                                        <td class="text-muted small" x-text="task.date"></td>
                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-link text-decoration-none p-0 me-2 text-secondary" @click="openModal(task)">编辑</button>
                                            <button class="btn btn-sm btn-link text-decoration-none p-0 text-danger" @click="deleteTask(task.id)">删除</button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="pagedTasks.length === 0">
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        暂无符合条件的任务
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页 -->
                    <div class="card-footer bg-white py-3" x-show="filteredTasks.length > 0">
                        <nav class="d-flex justify-content-end">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item" :class="{ disabled: page === 1 }">
                                    <button class="page-link" @click="page--">上一页</button>
                                </li>
                                <li class="page-item disabled"><span class="page-link text-muted" x-text="`第 ${page} 页`"></span></li>
                                <li class="page-item" :class="{ disabled: page * pageSize >= filteredTasks.length }">
                                    <button class="page-link" @click="page++">下一页</button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- 3. 设置视图 -->
            <div x-show="route === 'settings'" x-transition.opacity.duration.300ms>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3 border-bottom">
                                <h5 class="mb-0 fw-bold">系统设置</h5>
                            </div>
                            <div class="card-body p-4">
                                <form @submit.prevent="saveSettings">
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">个人资料</label>
                                        <div class="d-flex align-items-center gap-3 mb-3">
                                            <div class="bg-secondary bg-opacity-10 p-3 rounded-circle">
                                                <i data-lucide="user" width="32" height="32" class="text-secondary"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <label class="form-label small text-muted">显示名称</label>
                                                <input type="text" class="form-control" x-model="user.name">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label fw-bold">通知首选项</label>
                                        <div class="form-check form-switch py-2">
                                            <input class="form-check-input" type="checkbox" id="notifySwitch" x-model="user.notify">
                                            <label class="form-check-label" for="notifySwitch">启用每日邮件摘要</label>
                                        </div>
                                        <div class="form-text">我们会每天早上 9:00 向您发送待办任务提醒。</div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i data-lucide="save" width="16" class="me-1"></i> 保存更改
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 模态框 (使用 Bootstrap 原生结构) -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" x-text="editMode ? '编辑任务' : '新建任务'"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">任务标题</label>
                        <input type="text" class="form-control" x-model="currentTask.title" placeholder="要做什么？">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">优先级</label>
                        <select class="form-select" x-model="currentTask.priority">
                            <option value="low">低</option>
                            <option value="mid">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">截止日期</label>
                        <input type="date" class="form-control" x-model="currentTask.date">
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveTask">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 简单 Toast 提示 -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage">操作成功</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // --- 状态数据 ---
                route: 'dashboard',
                tasks: [],
                search: '',
                filter: '',
                page: 1,
                pageSize: 5,
                user: { name: 'Admin', notify: true },
                
                // 编辑/新建任务状态
                editMode: false,
                currentTask: { id: null, title: '', priority: 'mid', date: '', status: 'todo' },
                bsModal: null, // Bootstrap Modal 实例

                // --- 计算属性 ---
                get filteredTasks() {
                    return this.tasks.filter(t => {
                        const matchSearch = t.title.toLowerCase().includes(this.search.toLowerCase());
                        const matchFilter = !this.filter || t.status === this.filter;
                        return matchSearch && matchFilter;
                    });
                },
                get pagedTasks() {
                    const start = (this.page - 1) * this.pageSize;
                    return this.filteredTasks.slice(start, start + this.pageSize);
                },

                // --- 初始化与路由 ---
                initApp() {
                    // 1. 监听 Hash 变化 (核心路由逻辑)
                    window.addEventListener('hashchange', () => this.handleHashChange());
                    this.handleHashChange(); // 首次加载处理

                    // 2. 加载数据
                    this.loadData();

                    // 3. 初始化 Modal 对象
                    this.bsModal = new bootstrap.Modal(document.getElementById('taskModal'));
                    
                    // 4. 监听器
                    this.$watch('route', () => this.refreshIcons());
                    this.$watch('page', () => this.refreshIcons());
                    this.$watch('filteredTasks', () => { this.page = 1; this.refreshIcons(); });
                },

                handleHashChange() {
                    // 获取 hash，去掉 #。如果为空则默认为 dashboard
                    const hash = window.location.hash.substring(1);
                    this.route = hash || 'dashboard';
                    
                    // 如果 URL 是空的，强制加上 #dashboard 以保持一致
                    if (!hash) history.replaceState(null, null, '#dashboard');
                    
                    this.refreshIcons();
                },

                refreshIcons() {
                    this.$nextTick(() => lucide.createIcons());
                },

                // --- 数据操作 ---
                loadData() {
                    const storedTasks = localStorage.getItem('TM_TASKS');
                    if (storedTasks) {
                        this.tasks = JSON.parse(storedTasks);
                    } else {
                        // 默认数据
                        this.tasks = [
                            { id: 1, title: '完成项目季度报告', status: 'doing', priority: 'high', date: '2023-11-10' },
                            { id: 2, title: '团队建设活动策划', status: 'todo', priority: 'mid', date: '2023-11-12' },
                            { id: 3, title: '更新服务器 SSL 证书', status: 'done', priority: 'high', date: '2023-11-01' },
                            { id: 4, title: '采购新显示器', status: 'todo', priority: 'low', date: '2023-11-15' },
                            { id: 5, title: '面试新前端候选人', status: 'doing', priority: 'mid', date: '2023-11-11' },
                            { id: 6, title: '修复 iOS 兼容性 Bug', status: 'done', priority: 'high', date: '2023-10-30' },
                        ];
                        this.saveTasks();
                    }
                    const storedUser = localStorage.getItem('TM_USER');
                    if(storedUser) this.user = JSON.parse(storedUser);
                },
                saveTasks() { localStorage.setItem('TM_TASKS', JSON.stringify(this.tasks)); },
                
                openModal(task = null) {
                    this.editMode = !!task;
                    if (task) {
                        this.currentTask = { ...task };
                    } else {
                        this.currentTask = { id: Date.now(), title: '', priority: 'mid', date: new Date().toISOString().split('T')[0], status: 'todo' };
                    }
                    this.bsModal.show();
                },

                saveTask() {
                    if (!this.currentTask.title.trim()) {
                        alert('请输入任务标题');
                        return;
                    }

                    if (this.editMode) {
                        const index = this.tasks.findIndex(t => t.id === this.currentTask.id);
                        if (index !== -1) this.tasks[index] = { ...this.currentTask };
                        this.showToast('任务已更新');
                    } else {
                        this.tasks.unshift({ ...this.currentTask });
                        this.showToast('新任务已创建');
                    }
                    
                    this.saveTasks();
                    this.bsModal.hide();
                },

                deleteTask(id) {
                    if (confirm('确定要删除此任务吗？')) {
                        this.tasks = this.tasks.filter(t => t.id !== id);
                        this.saveTasks();
                        this.showToast('任务已删除');
                    }
                },

                saveSettings() {
                    localStorage.setItem('TM_USER', JSON.stringify(this.user));
                    this.showToast('设置已保存');
                },

                showToast(msg) {
                    document.getElementById('toastMessage').innerText = msg;
                    const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                    toast.show();
                },

                // --- 样式辅助 ---
                getPageTitle() {
                    const map = { 'dashboard': '概览仪表盘', 'tasks': '任务管理中心', 'settings': '系统设置' };
                    return map[this.route] || '未知页面';
                },
                getPageIcon() {
                    const map = { 'dashboard': 'layout-dashboard', 'tasks': 'list-todo', 'settings': 'settings' };
                    return map[this.route] || 'circle';
                },
                
                getStats() {
                    const total = this.tasks.length;
                    const done = this.tasks.filter(t => t.status === 'done').length;
                    const pending = total - done;
                    return [
                        { label: '总任务数', value: total, bgClass: 'bg-primary bg-opacity-10 text-primary', borderClass: 'bg-primary', icon: 'layers' },
                        { label: '已完成', value: done, bgClass: 'bg-success bg-opacity-10 text-success', borderClass: 'bg-success', icon: 'check-circle' },
                        { label: '待处理', value: pending, bgClass: 'bg-warning bg-opacity-10 text-warning', borderClass: 'bg-warning', icon: 'clock' }
                    ];
                },

                getPriorityBadge(p) {
                    return { 'high': 'text-bg-danger bg-opacity-75', 'mid': 'text-bg-warning text-white', 'low': 'text-bg-info text-white' }[p];
                },
                getStatusBadge(s) {
                    return { 'done': 'text-bg-success bg-opacity-25 text-success', 'doing': 'text-bg-primary bg-opacity-25 text-primary', 'todo': 'text-bg-light text-secondary' }[s];
                },
                getStatusIcon(s) {
                    return { 'done': 'check', 'doing': 'loader', 'todo': 'circle' }[s];
                },
                formatEnum(val) {
                    return { 'low': '低', 'mid': '中', 'high': '高' }[val] || val;
                },
                statusLabel(s) {
                    return { 'done': '已完成', 'doing': '进行中', 'todo': '待办' }[s];
                }
            }
        }
    </script>
</body>
</html>